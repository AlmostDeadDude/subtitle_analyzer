const fileInput=document.getElementById("file-upload"),uploadForm=document.getElementById("upload-container"),uploadBtn=uploadForm.querySelector('input[type="submit"]'),wordCloudCanvas=document.getElementById("word_cloud"),resultFilters=document.getElementById("result-filters"),filters=resultFilters.querySelectorAll('input[type="checkbox"]');async function uploadFile(e){e.preventDefault(),showLoading();const t=fileInput.files[0],n=document.getElementById("lang").value;if(!t)return alert("Please select a file."),void hideLoading();const o=new FormData;o.append("file",t),o.append("lang",n);try{const e=await fetch("upload.php",{method:"POST",body:o});if(hideLoading(),e.ok){const n=await e.json();"success"===n.status?(document.querySelector(".filename").innerHTML=t.name,resetFilters(),displayResults(n.message)):alert(`Error: ${n.message}`)}else{const t=await e.text();alert(`Error: ${t}`)}}catch(e){hideLoading(),alert("An unexpected error occurred.")}}function resetFilters(){filters.forEach((function(e){e.checked=!0}))}function showLoading(){document.getElementById("loading").style.display="block"}function hideLoading(){document.getElementById("loading").style.display="none"}function displayResults(e){const t=document.getElementById("result-wrapper"),n=document.getElementById("result-container");n.innerHTML="";let o=[];e.forEach((function(e){let t=e.word,l=e.pos,a=e.frequency,r=e.timestamps,i=secondsToStr(e.starts);o.push([t,a]);let d=document.createElement("div");d.className="word "+l;let s=document.createElement("div");s.className="word-wrapper central row";let c=document.createElement("p");c.className="word-name",c.innerHTML=t;let u=document.createElement("p");u.className="word-freq",u.innerHTML=a,s.appendChild(c),s.appendChild(u),d.appendChild(s);let p=document.createElement("p");p.className="start-time hidden";let m=document.createElement("div");m.className="timestamps-wrapper";let h=document.createElement("div");h.className="timestamps",r.forEach((function(e,t){let n=document.createElement("div");n.className="timestamp",n.style.left=e+"%",n.setAttribute("data-start",i[t]),n.addEventListener("mouseover",(function(e){p.classList.remove("hidden"),p.innerHTML=i[t]})),n.addEventListener("mouseout",(function(e){p.classList.add("hidden")})),h.appendChild(n)})),m.appendChild(h),d.appendChild(m),d.appendChild(p),n.appendChild(d)})),displayWordCloud(o),wordCloudCanvas.style.display="block",t.style.display="block",localStorage.getItem("SUBTITLE_CHECK_modalShown")?document.querySelector(".filename").scrollIntoView({behavior:"smooth",block:"start"}):showModal("What do the results mean?",'<picture><source type="image/avif" srcset="res/img/example.avif"><source type="image/webp" srcset="res/img/example.webp"><img decoding="async" loading="lazy" src="res/img/example.png"  alt="an example image"/></picture>',!1,[function(){localStorage.setItem("SUBTITLE_CHECK_modalShown",!0),hideModal(),document.querySelector(".filename").scrollIntoView({behavior:"smooth",block:"start"})},null],["Got it",null])}function secondsToStr(e){let t=[];return e.forEach((function(e){let n=Math.floor(e/3600),o=Math.floor((e-3600*n)/60),l=Math.floor(e-3600*n-60*o),a=n.toString().padStart(2,"0")+":"+o.toString().padStart(2,"0")+":"+l.toString().padStart(2,"0");t.push(a)})),t}function preventDefaults(e){e.preventDefault(),e.stopPropagation()}function handleDrop(e){const t=e.dataTransfer.files;t.length>0&&(document.getElementById("file-upload").files=t,uploadFile())}function highlight(){uploadForm.classList.add("highlight")}function unhighlight(){uploadForm.classList.remove("highlight")}function displayWordCloud(e){WordCloud(wordCloudCanvas,{list:e,fontFamily:"Walter Turncoat, cursive",minSize:10,weightFactor:2,color:"#231f34",clearCanvas:!0,backgroundColor:"transparent",shape:"circle",ellipticity:.3,drawOutOfBound:!1,shrinkToFit:!0})}fileInput.addEventListener("change",(function(e){e.target.files[0]&&(uploadBtn.disabled=!1,uploadBtn.value="Upload")})),uploadForm.addEventListener("submit",uploadFile),["dragenter","dragover","dragleave","drop"].forEach((e=>{uploadForm.addEventListener(e,preventDefaults,!1)})),uploadForm.addEventListener("drop",handleDrop,!1),uploadForm.addEventListener("dragenter",highlight,!1),uploadForm.addEventListener("dragover",highlight,!1),uploadForm.addEventListener("dragleave",unhighlight,!1),uploadForm.addEventListener("drop",unhighlight,!1),filters.forEach((function(e){e.addEventListener("input",(function(t){let n=e.name;document.querySelectorAll(".word."+n).forEach((function(e){e.classList.toggle("hidden")}));let o=document.querySelectorAll(".word:not(.hidden)"),l=[];o.forEach((function(e){let t=e.querySelector(".word-name").innerHTML,n=e.querySelector(".word-freq").innerHTML;l.push([t,n])})),displayWordCloud(l)}))}));const godfather_link=document.getElementById("godfather_link"),pulpfiction_link=document.getElementById("pulpfiction_link"),lebowski_link=document.getElementById("lebowski_link");async function uploadCustomFile(e){showLoading(),document.getElementById("loading").scrollIntoView({behavior:"smooth",block:"center"});let t=null,n=null;switch(e){case"godfather":t="GodFather.srt",n="subs/"+t;break;case"pulpfiction":t="PulpFiction.srt",n="subs/"+t;break;case"lebowski":t="TheBigLebowski.srt",n="subs/"+t;break;default:break}const o=await fetch(n).then((e=>e.blob())),l=new File([o],t),a=new FormData;a.append("file",l),a.append("lang","en");try{const e=await fetch("upload.php",{method:"POST",body:a});if(hideLoading(),e.ok){const t=await e.json();"success"===t.status?(document.querySelector(".filename").innerHTML=l.name,resetFilters(),displayResults(t.message)):alert(`Error: ${t.message}`)}else{const t=await e.text();alert(`Error: ${t}`)}}catch(e){hideLoading(),alert("An unexpected error occurred.")}}godfather_link.addEventListener("click",(function(e){e.preventDefault(),uploadCustomFile("godfather")})),pulpfiction_link.addEventListener("click",(function(e){e.preventDefault(),uploadCustomFile("pulpfiction")})),lebowski_link.addEventListener("click",(function(e){e.preventDefault(),uploadCustomFile("lebowski")}));